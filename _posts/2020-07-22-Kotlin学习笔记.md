---
layout: post
title: "Kotlinå­¦ä¹ ç¬”è®°"
date: 2020-07-22 15:54:23 +0800
categories: [Android,Kotlin]
tags: Android,Kotlin
comments: 1
toc: true
---

å‚è€ƒ:[ç ä¸Šå¼€å­¦](https://kaixue.io/)

> val ã€Œåªè¯»å˜é‡ã€ var ã€Œå¯å˜å˜é‡ã€

### åŸºæœ¬ç±»å‹æ‹†è£…ç®±
Kotlin é‡Œçš„ Int å’Œ Java é‡Œçš„ int ä»¥åŠ Integer ä¸åŒï¼Œä¸»è¦æ˜¯åœ¨è£…ç®±æ–¹é¢ä¸åŒã€‚
```
1.Java é‡Œçš„ int æ˜¯ unbox çš„ï¼Œè€Œ Integer æ˜¯ box çš„ï¼š

â˜•ï¸
int a = 1;
Integer b = 2; // ğŸ‘ˆä¼šè¢«è‡ªåŠ¨è£…ç®± autoboxing
Java
Kotlin é‡Œï¼ŒInt æ˜¯å¦è£…ç®±æ ¹æ®åœºåˆæ¥å®šï¼š

ğŸï¸
var a: Int = 1 // unbox
var b: Int? = 2 // box
var list: List<Int> = listOf(1, 2) // box


2.Java ä¸­çš„æ•°ç»„å’Œ Kotlin ä¸­çš„æ•°ç»„çš„å†™æ³•ä¹Ÿæœ‰åŒºåˆ«ï¼š

â˜•ï¸
int[] array = new int[] {1, 2};
Java
è€Œåœ¨ Kotlin é‡Œï¼Œä¸Šé¢çš„å†™æ³•æ˜¯è¿™æ ·çš„ï¼š

ğŸï¸
var array: IntArray = intArrayOf(1, 2)
// ğŸ‘†è¿™ç§ä¹Ÿæ˜¯ unbox çš„

```
> Java é‡Œçš„åŸºæœ¬ç±»å‹ï¼Œç±»æ¯”åˆ° Kotlin é‡Œé¢ï¼Œæ¡ä»¶æ»¡è¶³å¦‚ä¸‹ä¹‹ä¸€å°±ä¸è£…ç®±ï¼š

- 1.ä¸å¯ç©ºç±»å‹ã€‚
- 2.ä½¿ç”¨ IntArrayã€FloatArray ç­‰ã€‚


### Kotlin å¤„ç†å¼ºè½¬é”™è¯¯çš„æ–¹å¼
```
ğŸï¸
fun main() {
    var activity: Activity = NewActivity()
    // ğŸ‘‡'(activity as? NewActivity)' ä¹‹åæ˜¯ä¸€ä¸ªå¯ç©ºç±»å‹çš„å¯¹è±¡ï¼Œæ‰€ä»¥ï¼Œéœ€è¦ä½¿ç”¨ '?.' æ¥è°ƒç”¨
    (activity as? NewActivity)?.action()
}
```
> æ€è€ƒ:

1.å­ç±»é‡å†™çˆ¶ç±»çš„ override å‡½æ•°ï¼Œèƒ½å¦ä¿®æ”¹å®ƒçš„å¯è§æ€§ï¼Ÿ
2.ä»¥ä¸‹çš„å†™æ³•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

```
ğŸï¸
activity as? NewActivity
activity as NewActivity?
activity as? NewActivity?
```
ğŸ
```
@Test
   fun test() {
       val str = "hello"
       //str as Context
       //str as? Context
       str as? Context?

       /*
       1.ç›´æ¥æŠ›å¼‚å¸¸ : java.lang.ClassCastException: java.lang.String cannot be cast to android.content.Context
       2.é€šè¿‡
       3.é€šè¿‡

       æ­¤æ—¶ : val str="hello"  -> val str=null
       str as? Context? å’Œ str æ˜¯ç­‰æ•ˆçš„
        */

   }
```
### valè‡ªå®šä¹‰ getter
ä¸è¿‡ val å’Œ final è¿˜æ˜¯æœ‰ä¸€ç‚¹åŒºåˆ«çš„ï¼Œè™½ç„¶ val ä¿®é¥°çš„å˜é‡ä¸èƒ½äºŒæ¬¡èµ‹å€¼ï¼Œä½†å¯ä»¥é€šè¿‡è‡ªå®šä¹‰å˜é‡çš„ getter å‡½æ•°ï¼Œè®©å˜é‡æ¯æ¬¡è¢«è®¿é—®æ—¶ï¼Œè¿”å›åŠ¨æ€è·å–çš„å€¼ï¼š
```
ğŸï¸
ğŸ‘‡
val size: Int
    get() { // ğŸ‘ˆ æ¯æ¬¡è·å– size å€¼æ—¶éƒ½ä¼šæ‰§è¡Œ items.size
        return items.size
    }
```
ä¸è¿‡è¿™ä¸ªå±äº val çš„å¦å¤–ä¸€ç§ç”¨æ³•ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ val è¿˜æ˜¯å¯¹åº”äº Java ä¸­çš„ final ä½¿ç”¨çš„ã€‚

### Kotlin ä¸­çš„ object
- åˆ›å»ºä¸€ä¸ªç±»ï¼Œå¹¶ä¸”åˆ›å»ºä¸€ä¸ªè¿™ä¸ªç±»çš„å¯¹è±¡ã€‚è¿™ä¸ªå°±æ˜¯ object çš„æ„æ€ï¼šå¯¹è±¡ã€‚
- åˆ›å»ºå•ä¾‹ , åªéœ€è¦æŠŠ class æ¢æˆ object å°±å¯ä»¥äº†ã€‚
- object å®ç°çš„å•ä¾‹æ˜¯ä¸€ä¸ªé¥¿æ±‰å¼çš„å•ä¾‹ï¼Œå¹¶ä¸”å®ç°äº†çº¿ç¨‹å®‰å…¨ã€‚
- Java ä¸­çš„é™æ€åˆå§‹åŒ–
```
static{ ... }
ğŸï¸
Java ä¸­çš„é™æ€å˜é‡å’Œæ–¹æ³•ï¼Œåœ¨ Kotlin ä¸­éƒ½æ”¾åœ¨äº† companion object ä¸­ã€‚å› æ­¤ Java ä¸­çš„é™æ€åˆå§‹åŒ–åœ¨ Kotlin ä¸­è‡ªç„¶ä¹Ÿæ˜¯æ”¾åœ¨ companion object ä¸­çš„ï¼Œåƒç±»çš„åˆå§‹åŒ–ä»£ç ä¸€æ ·ï¼Œç”± init å’Œä¸€å¯¹å¤§æ‹¬å·è¡¨ç¤ºï¼š
ğŸï¸
class Sample {
       ğŸ‘‡
    companion object {
         ğŸ‘‡
        init {
            ...
        }
    }
}
```
> é‚£åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œåœ¨ objectã€companion object å’Œ top-level ä¸­è¯¥é€‰æ‹©å“ªä¸€ä¸ªå‘¢ï¼Ÿç®€å•æ¥è¯´æŒ‰ç…§ä¸‹é¢è¿™ä¸¤ä¸ªåŸåˆ™åˆ¤æ–­ï¼š

- å¦‚æœæƒ³å†™å·¥å…·ç±»çš„åŠŸèƒ½ï¼Œç›´æ¥åˆ›å»ºæ–‡ä»¶ï¼Œå†™ top-levelã€Œé¡¶å±‚ã€å‡½æ•°ã€‚
- å¦‚æœéœ€è¦ç»§æ‰¿åˆ«çš„ç±»æˆ–è€…å®ç°æ¥å£ï¼Œå°±ç”¨ object æˆ– companion objectã€‚

### Kotlinå¸¸é‡å’ŒJavaå¸¸é‡çš„åŒºåˆ«
```
å‘ç°ä¸åŒç‚¹æœ‰ï¼š

Kotlin çš„å¸¸é‡å¿…é¡»å£°æ˜åœ¨å¯¹è±¡ï¼ˆåŒ…æ‹¬ä¼´ç”Ÿå¯¹è±¡ï¼‰æˆ–è€…ã€Œtop-level é¡¶å±‚ã€ä¸­ï¼Œå› ä¸ºå¸¸é‡æ˜¯é™æ€çš„ã€‚
Kotlin æ–°å¢äº†ä¿®é¥°å¸¸é‡çš„ const å…³é”®å­—ã€‚
é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€ä¸ªåŒºåˆ«ï¼š

Kotlin ä¸­åªæœ‰åŸºæœ¬ç±»å‹å’Œ String ç±»å‹å¯ä»¥å£°æ˜æˆå¸¸é‡ã€‚
åŸå› æ˜¯ Kotlin ä¸­çš„å¸¸é‡æŒ‡çš„æ˜¯ ã€Œcompile-time constant ç¼–è¯‘æ—¶å¸¸é‡ã€ï¼Œå®ƒçš„æ„æ€æ˜¯ã€Œç¼–è¯‘å™¨åœ¨ç¼–è¯‘çš„æ—¶å€™å°±çŸ¥é“è¿™ä¸ªä¸œè¥¿åœ¨æ¯ä¸ªè°ƒç”¨å¤„çš„å®é™…å€¼ã€ï¼Œå› æ­¤å¯ä»¥åœ¨ç¼–è¯‘æ—¶ç›´æ¥æŠŠè¿™ä¸ªå€¼ç¡¬ç¼–ç åˆ°ä»£ç é‡Œä½¿ç”¨çš„åœ°æ–¹ã€‚


Java ä¸­çš„å¸¸é‡å¯ä»¥è®¤ä¸ºæ˜¯ã€Œä¼ªå¸¸é‡ã€ï¼Œå› ä¸ºå¯ä»¥é€šè¿‡ä¸Šé¢è¿™ç§æ–¹å¼æ”¹å˜å®ƒå†…éƒ¨çš„å€¼ã€‚è€Œ Kotlin çš„å¸¸é‡å› ä¸ºé™åˆ¶ç±»å‹å¿…é¡»æ˜¯åŸºæœ¬ç±»å‹ï¼Œæ‰€ä»¥ä¸å­˜åœ¨è¿™ç§é—®é¢˜ï¼Œæ›´ç¬¦åˆå¸¸é‡çš„å®šä¹‰ã€‚

```

### Kotlin mutable å‰ç¼€æ³¨æ„é—®é¢˜
```
listOf() åˆ›å»ºä¸å¯å˜çš„ Listï¼ŒmutableListOf() åˆ›å»ºå¯å˜çš„ Listã€‚å¯é€šè¿‡ toMutableList ç”±ä¸å¯å˜è½¬æˆå¯å˜é›†åˆ:
ğŸï¸
val strList = listOf("a", "b", "c")
            ğŸ‘‡
strList.toMutableList()

ğŸ‘‰ toMutable*() è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°å»ºçš„é›†åˆï¼ŒåŸæœ‰çš„é›†åˆè¿˜æ˜¯ä¸å¯å˜çš„ï¼Œæ‰€ä»¥åªèƒ½å¯¹å‡½æ•°è¿”å›çš„é›†åˆä¿®æ”¹ã€‚
```

### å¯è§æ€§ä¿®é¥°ç¬¦
- public ï¼šå…¬å¼€ï¼Œå¯è§æ€§æœ€å¤§ï¼Œå“ªé‡Œéƒ½å¯ä»¥å¼•ç”¨ã€‚
- privateï¼šç§æœ‰ï¼Œå¯è§æ€§æœ€å°ï¼Œæ ¹æ®å£°æ˜ä½ç½®ä¸åŒå¯åˆ†ä¸ºç±»ä¸­å¯è§å’Œæ–‡ä»¶ä¸­å¯è§ã€‚
- protectedï¼šä¿æŠ¤ï¼Œç›¸å½“äº private + å­ç±»å¯è§ã€‚
- internalï¼šå†…éƒ¨ï¼Œä»…å¯¹ module å†…å¯è§ã€‚

Kotlin ä¸­å¦‚æœä¸å†™å¯è§æ€§ä¿®é¥°ç¬¦ï¼Œå°±è¡¨ç¤ºå…¬å¼€ï¼Œå’Œ Java ä¸­ public ä¿®é¥°ç¬¦å…·æœ‰ç›¸åŒæ•ˆæœã€‚åœ¨ Kotlin ä¸­ public ä¿®é¥°ç¬¦ã€Œå¯ä»¥åŠ ï¼Œä½†æ²¡å¿…è¦ã€ã€‚

> internal è¡¨ç¤ºä¿®é¥°çš„ç±»ã€å‡½æ•°ä»…å¯¹ module å†…å¯è§ï¼Œè¿™é‡Œçš„ module å…·ä½“æŒ‡çš„æ˜¯ä¸€ç»„å…±åŒç¼–è¯‘çš„ kotlin æ–‡ä»¶ï¼Œå¸¸è§çš„å½¢å¼æœ‰ï¼š

- Android Studio é‡Œçš„ module
- Maven project

> private
Java ä¸­çš„ private è¡¨ç¤ºç±»ä¸­å¯è§ï¼Œä½œä¸ºå†…éƒ¨ç±»æ—¶å¯¹å¤–éƒ¨ç±»ã€Œå¯è§ã€ã€‚
Kotlin ä¸­çš„ private è¡¨ç¤ºç±»ä¸­æˆ–æ‰€åœ¨æ–‡ä»¶å†…å¯è§ï¼Œä½œä¸ºå†…éƒ¨ç±»æ—¶å¯¹å¤–éƒ¨ç±»ã€Œä¸å¯è§ã€

ğŸŒ°
```
åœ¨ Java ä¸­ï¼Œå¤–éƒ¨ç±»å¯ä»¥è®¿é—®å†…éƒ¨ç±»çš„ private å˜é‡ï¼š

â˜•ï¸
public class Outter {
    public void method() {
        Inner inner = new Inner();
                            ğŸ‘‡
        int result = inner.number * 2; // success
    }

    private class Inner {
        private int number = 0;
    }
}
Java
åœ¨ Kotlin ä¸­ï¼Œå¤–éƒ¨ç±»ä¸å¯ä»¥è®¿é—®å†…éƒ¨ç±»çš„ private å˜é‡ï¼š

ğŸï¸
class Outter {
    fun method() {
        val inner = Inner()
                            ğŸ‘‡
        val result = inner.number * 2 // compile-error: Cannot access 'number': it is private in 'Inner'
    }

    class Inner {
        private val number = 1
    }
}
```

# é«˜é˜¶å‡½æ•°å’ŒLambdaè¡¨è¾¾å¼
> è¯¾ä»¶ ğŸ‘‰ <https://kaixue.io/kotlin-lambda/>
> Bilibili ğŸ‘‰ <https://www.bilibili.com/video/av96768809>

## æ¦‚å¿µ
ã€Œå‚æ•°æˆ–è€…è¿”å›å€¼ä¸ºå‡½æ•°ç±»å‹çš„å‡½æ•°ã€ï¼Œåœ¨ Kotlin ä¸­å°±è¢«ç§°ä¸ºã€Œé«˜é˜¶å‡½æ•°ã€â€”â€” Higher-Order Functionsã€‚
â­ Kotlinä¸­åŒå†’å·å‡½æ•°,åŒ¿åå‡½æ•°å’ŒLambdaè¡¨è¾¾å¼æœ¬è´¨ä¸Šéƒ½æ˜¯å‡½æ•°ç±»å‹çš„å¯¹è±¡ã€‚

## é«˜é˜¶å‡½æ•°
åŒå†’å· **::** æŠŠå£°æ˜å¥½çš„å‡½æ•°å˜æˆå‡½æ•°ç±»å‹çš„å¯¹è±¡ :
```
fun b(param: Int): String {
    return ""
}
val d = ::b
val e = d
```
å¯¹è±¡æ˜¯ä¸èƒ½åŠ ä¸ªæ‹¬å·æ¥è°ƒç”¨çš„ï¼Œå¯¹å§ï¼Ÿä½†æ˜¯å‡½æ•°ç±»å‹çš„å¯¹è±¡å¯ä»¥ã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºè¿™å…¶å®æ˜¯ä¸ªå‡çš„è°ƒç”¨ï¼Œå®ƒæ˜¯ Kotlin çš„è¯­æ³•ç³–ï¼Œå®é™…ä¸Šä½ å¯¹ä¸€ä¸ªå‡½æ•°ç±»å‹çš„å¯¹è±¡åŠ æ‹¬å·ã€åŠ å‚æ•°ï¼Œå®ƒçœŸæ­£è°ƒç”¨çš„æ˜¯è¿™ä¸ªå¯¹è±¡çš„ invoke() å‡½æ•°ï¼š
```
d(1) // å®é™…ä¸Šä¼šè°ƒç”¨ d.invoke(1)
(::b)(1) // å®é™…ä¸Šä¼šè°ƒç”¨ (::b).invoke(1)
```
åŒ…æ‹¬åŒå†’å·åŠ ä¸Šå‡½æ•°åçš„è¿™ä¸ªå†™æ³•ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘å¯¹è±¡çš„å¼•ç”¨ï¼Œä½†å¹¶ä¸æ˜¯æŒ‡å‘å‡½æ•°æœ¬èº«ï¼Œè€Œæ˜¯æŒ‡å‘ä¸€ä¸ªæˆ‘ä»¬åœ¨ä»£ç é‡Œçœ‹ä¸è§çš„å¯¹è±¡ã€‚è¿™ä¸ªå¯¹è±¡å¤åˆ¶äº†åŸå‡½æ•°çš„åŠŸèƒ½ï¼Œä½†å®ƒå¹¶ä¸æ˜¯åŸå‡½æ•°ã€‚

# åç¨‹
ä¸€ç§çº¿ç¨‹æ¡†æ¶ã€‚

## åˆ›å»ºåç¨‹

```
ğŸï¸
// æ–¹æ³•ä¸€ï¼Œä½¿ç”¨ runBlocking é¡¶å±‚å‡½æ•°
runBlocking {
    getImage(imageId)
}

// æ–¹æ³•äºŒï¼Œä½¿ç”¨ GlobalScope å•ä¾‹å¯¹è±¡
//            ğŸ‘‡ å¯ä»¥ç›´æ¥è°ƒç”¨ launch å¼€å¯åç¨‹
GlobalScope.launch {
    getImage(imageId)
}

// æ–¹æ³•ä¸‰ï¼Œè‡ªè¡Œé€šè¿‡ CoroutineContext åˆ›å»ºä¸€ä¸ª CoroutineScope å¯¹è±¡
//                                    ğŸ‘‡ éœ€è¦ä¸€ä¸ªç±»å‹ä¸º CoroutineContext çš„å‚æ•°
val coroutineScope = CoroutineScope(context)
coroutineScope.launch {
    getImage(imageId)
}
```
- æ–¹æ³•ä¸€é€šå¸¸é€‚ç”¨äºå•å…ƒæµ‹è¯•çš„åœºæ™¯ï¼Œè€Œä¸šåŠ¡å¼€å‘ä¸­ä¸ä¼šç”¨åˆ°è¿™ç§æ–¹æ³•ï¼Œå› ä¸ºå®ƒæ˜¯çº¿ç¨‹é˜»å¡çš„ã€‚

- æ–¹æ³•äºŒå’Œä½¿ç”¨ runBlocking çš„åŒºåˆ«åœ¨äºä¸ä¼šé˜»å¡çº¿ç¨‹ã€‚ä½†åœ¨ Android å¼€å‘ä¸­åŒæ ·ä¸æ¨èè¿™ç§ç”¨æ³•ï¼Œå› ä¸ºå®ƒçš„ç”Ÿå‘½å‘¨æœŸä¼šå’Œ app ä¸€è‡´ï¼Œä¸”ä¸èƒ½å–æ¶ˆï¼ˆä»€ä¹ˆæ˜¯åç¨‹çš„å–æ¶ˆåé¢çš„æ–‡ç« ä¼šè®²ï¼‰ã€‚

- æ–¹æ³•ä¸‰æ˜¯æ¯”è¾ƒæ¨èçš„ä½¿ç”¨æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ context å‚æ•°å»ç®¡ç†å’Œæ§åˆ¶åç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼ˆè¿™é‡Œçš„ context å’Œ Android é‡Œçš„ä¸æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼Œæ˜¯ä¸€ä¸ªæ›´é€šç”¨çš„æ¦‚å¿µï¼Œä¼šæœ‰ä¸€ä¸ª Android å¹³å°çš„å°è£…æ¥é…åˆä½¿ç”¨ï¼‰ã€‚

### withContext
withContext è¿™ä¸ªå‡½æ•°å¯ä»¥åˆ‡æ¢åˆ°æŒ‡å®šçš„çº¿ç¨‹ï¼Œå¹¶åœ¨é—­åŒ…å†…çš„é€»è¾‘æ‰§è¡Œç»“æŸä¹‹åï¼Œè‡ªåŠ¨æŠŠçº¿ç¨‹åˆ‡å›å»ç»§ç»­æ‰§è¡Œã€‚

```
ğŸï¸
launch(Dispatchers.Main) {              // ğŸ‘ˆ åœ¨ UI çº¿ç¨‹å¼€å§‹
    val image = getImage(imageId)
    avatarIv.setImageBitmap(image)     // ğŸ‘ˆ æ‰§è¡Œç»“æŸåï¼Œè‡ªåŠ¨åˆ‡æ¢å› UI çº¿ç¨‹
}
//                               ğŸ‘‡
suspend fun getImage(imageId: Int) = withContext(Dispatchers.IO) {
    ...
}
```


## åˆå¹¶ç½‘ç»œè¯·æ±‚å¹¶æ›´æ–°UI
```
ğŸï¸ ã€Œåä½œå¼ä»»åŠ¡ã€
coroutineScope.launch(Dispatchers.Main) {
    //            ğŸ‘‡  async å‡½æ•°ä¹‹åå†è®²
    val avatar = async { api.getAvatar(user) }    // è·å–ç”¨æˆ·å¤´åƒ
    val logo = async { api.getCompanyLogo(user) } // è·å–ç”¨æˆ·æ‰€åœ¨å…¬å¸çš„ logo
    val merged = suspendingMerge(avatar, logo)    // åˆå¹¶ç»“æœ
    //                  ğŸ‘†
    show(merged) // æ›´æ–° UI
}
```
## é¡¹ç›®ä¸­é…ç½®å¯¹ Kotlin åç¨‹çš„æ”¯æŒ
- é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ build.gradle :

```
buildscript {
    ...
    // ğŸ‘‡
    ext.kotlin_coroutines = '1.3.1'
    ...
}
```
- Module ä¸‹çš„ build.gradle :

```
dependencies {
    ...
    //                                       ğŸ‘‡ ä¾èµ–åç¨‹æ ¸å¿ƒåº“
    implementation "org.jetbrains.kotlinx:kotlinx-coroutines-core:$kotlin_coroutines"
    //                                       ğŸ‘‡ ä¾èµ–å½“å‰å¹³å°æ‰€å¯¹åº”çš„å¹³å°åº“
    implementation "org.jetbrains.kotlinx:kotlinx-coroutines-android:$kotlin_coroutines"
    ...
}
```

## launch ä¸ async
æ¥ä¸‹æ¥æˆ‘ä»¬ä¸»è¦æ¥å¯¹æ¯” launch ä¸ async è¿™ä¸¤ä¸ªå‡½æ•°ã€‚

- ç›¸åŒç‚¹ï¼šå®ƒä»¬éƒ½å¯ä»¥ç”¨æ¥å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œè¿”å›çš„éƒ½æ˜¯ Coroutineï¼Œæˆ‘ä»¬è¿™é‡Œä¸éœ€è¦çº ç»“å…·ä½“æ˜¯è¿”å›å“ªä¸ªç±»ã€‚

- ä¸åŒç‚¹ï¼šasync è¿”å›çš„ Coroutine å¤šå®ç°äº† Deferred æ¥å£ã€‚

å…³äº Deferred æ›´æ·±å…¥çš„çŸ¥è¯†å°±ä¸åœ¨è¿™é‡Œè¿‡å¤šé˜è¿°ï¼Œå®ƒçš„æ„æ€å°±æ˜¯å»¶è¿Ÿï¼Œä¹Ÿå°±æ˜¯ç»“æœç¨åæ‰èƒ½æ‹¿åˆ°ã€‚

æˆ‘ä»¬è°ƒç”¨ Deferred.await() å°±å¯ä»¥å¾—åˆ°ç»“æœäº†ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­çœ‹çœ‹ async æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Œå…ˆå›å¿†ä¸€ä¸‹ä¸ŠæœŸä¸­è·å–å¤´åƒçš„åœºæ™¯ï¼š
```
ğŸï¸
coroutineScope.launch(Dispatchers.Main) {
    //                      ğŸ‘‡  async å‡½æ•°å¯åŠ¨æ–°çš„åç¨‹
    val avatar: Deferred = async { api.getAvatar(user) }    // è·å–ç”¨æˆ·å¤´åƒ
    val logo: Deferred = async { api.getCompanyLogo(user) } // è·å–ç”¨æˆ·æ‰€åœ¨å…¬å¸çš„ logo
    //            ğŸ‘‡          ğŸ‘‡ è·å–è¿”å›å€¼
    show(avatar.await(), logo.await())                     // æ›´æ–° UI
}
```
å¯ä»¥çœ‹åˆ° avatar å’Œ logo çš„ç±»å‹å¯ä»¥å£°æ˜ä¸º Deferred ï¼Œé€šè¿‡ await è·å–ç»“æœå¹¶ä¸”æ›´æ–°åˆ° UI ä¸Šæ˜¾ç¤ºã€‚

await å‡½æ•°ç­¾åå¦‚ä¸‹ï¼š
```
ğŸï¸
public suspend fun await(): T
```

## ã€ŒæŒ‚èµ·ã€çš„æœ¬è´¨
ä¸€ä¸ªç¨åä¼šè¢«è‡ªåŠ¨åˆ‡å›æ¥çš„çº¿ç¨‹è°ƒåº¦æ“ä½œã€‚

æŒ‚èµ·çš„å¯¹è±¡æ˜¯åç¨‹ã€‚

ä»å½“å‰çº¿ç¨‹æŒ‚èµ·ã€‚æ¢å¥è¯è¯´ï¼Œå°±æ˜¯è¿™ä¸ªåç¨‹ä»æ­£åœ¨æ‰§è¡Œå®ƒçš„çº¿ç¨‹ä¸Šè„±ç¦»ã€‚æ³¨æ„ï¼Œä¸æ˜¯è¿™ä¸ªåç¨‹åœä¸‹æ¥äº†ï¼æ˜¯è„±ç¦»ï¼Œå½“å‰çº¿ç¨‹ä¸å†ç®¡è¿™ä¸ªåç¨‹è¦å»åšä»€ä¹ˆäº†ã€‚

suspend æ˜¯æœ‰æš‚åœçš„æ„æ€ï¼Œä½†æˆ‘ä»¬åœ¨åç¨‹ä¸­åº”è¯¥ç†è§£ä¸ºï¼šå½“çº¿ç¨‹æ‰§è¡Œåˆ°åç¨‹çš„ suspend å‡½æ•°çš„æ—¶å€™ï¼Œæš‚æ—¶ä¸ç»§ç»­æ‰§è¡Œåç¨‹ä»£ç äº†ã€‚

æˆ‘ä»¬å…ˆè®©æ—¶é—´é™æ­¢ï¼Œç„¶åå…µåˆ†ä¸¤è·¯ï¼Œåˆ†åˆ«çœ‹çœ‹è¿™ä¸¤ä¸ªäº’ç›¸è„±ç¦»çš„çº¿ç¨‹å’Œåç¨‹æ¥ä¸‹æ¥å°†ä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…ï¼š

### 1.çº¿ç¨‹

å‰é¢æˆ‘ä»¬æåˆ°ï¼ŒæŒ‚èµ·ä¼šè®©åç¨‹ä»æ­£åœ¨æ‰§è¡Œå®ƒçš„çº¿ç¨‹ä¸Šè„±ç¦»ï¼Œå…·ä½“åˆ°ä»£ç å…¶å®æ˜¯ï¼š

åç¨‹çš„ä»£ç å—ä¸­ï¼Œçº¿ç¨‹æ‰§è¡Œåˆ°äº† suspend å‡½æ•°è¿™é‡Œçš„æ—¶å€™ï¼Œå°±æš‚æ—¶ä¸å†æ‰§è¡Œå‰©ä½™çš„åç¨‹ä»£ç ï¼Œè·³å‡ºåç¨‹çš„ä»£ç å—ã€‚

é‚£çº¿ç¨‹æ¥ä¸‹æ¥ä¼šåšä»€ä¹ˆå‘¢ï¼Ÿ

å¦‚æœå®ƒæ˜¯ä¸€ä¸ªåå°çº¿ç¨‹ï¼š

- è¦ä¹ˆæ— äº‹å¯åšï¼Œè¢«ç³»ç»Ÿå›æ”¶
- è¦ä¹ˆç»§ç»­æ‰§è¡Œåˆ«çš„åå°ä»»åŠ¡

è·Ÿ Java çº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹åœ¨å·¥ä½œç»“æŸä¹‹åæ˜¯å®Œå…¨ä¸€æ ·çš„ï¼šå›æ”¶æˆ–è€…å†åˆ©ç”¨ã€‚

å¦‚æœè¿™ä¸ªçº¿ç¨‹å®ƒæ˜¯ Android çš„ä¸»çº¿ç¨‹ï¼Œé‚£å®ƒæ¥ä¸‹æ¥å°±ä¼šç»§ç»­å›å»å·¥ä½œï¼šä¹Ÿå°±æ˜¯ä¸€ç§’é’Ÿ 60 æ¬¡çš„ç•Œé¢åˆ·æ–°ä»»åŠ¡ã€‚

ä¸€ä¸ªå¸¸è§çš„åœºæ™¯æ˜¯ï¼Œè·å–ä¸€ä¸ªå›¾ç‰‡ï¼Œç„¶åæ˜¾ç¤ºå‡ºæ¥ï¼š
```
ğŸï¸
// ä¸»çº¿ç¨‹ä¸­
GlobalScope.launch(Dispatchers.Main) {
  val image = suspendingGetImage(imageId)  // è·å–å›¾ç‰‡
  avatarIv.setImageBitmap(image)           // æ˜¾ç¤ºå‡ºæ¥
}

suspend fun suspendingGetImage(id: String) = withContext(Dispatchers.IO) {
  ...
}
```
è¿™æ®µæ‰§è¡Œåœ¨ä¸»çº¿ç¨‹çš„åç¨‹ï¼Œå®ƒå®è´¨ä¸Šä¼šå¾€ä½ çš„ä¸»çº¿ç¨‹ post ä¸€ä¸ª Runnableï¼Œè¿™ä¸ª Runnable å°±æ˜¯ä½ çš„åç¨‹ä»£ç ï¼š
```
ğŸï¸
handler.post {
  val image = suspendingGetImage(imageId)
  avatarIv.setImageBitmap(image)
}
```
å½“è¿™ä¸ªåç¨‹è¢«æŒ‚èµ·çš„æ—¶å€™ï¼Œå°±æ˜¯ä¸»çº¿ç¨‹ post çš„è¿™ä¸ª Runnable æå‰ç»“æŸï¼Œç„¶åç»§ç»­æ‰§è¡Œå®ƒç•Œé¢åˆ·æ–°çš„ä»»åŠ¡ã€‚

### 2.åç¨‹
å®ƒä» suspend å‡½æ•°å¼€å§‹è„±ç¦»å¯åŠ¨å®ƒçš„çº¿ç¨‹ï¼Œç»§ç»­æ‰§è¡Œåœ¨ Dispatchers æ‰€æŒ‡å®šçš„ IO çº¿ç¨‹ã€‚

ç´§æ¥ç€åœ¨ suspend å‡½æ•°æ‰§è¡Œå®Œæˆä¹‹åï¼Œåç¨‹ä¸ºæˆ‘ä»¬åšçš„æœ€çˆ½çš„äº‹å°±æ¥äº†ï¼šä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬æŠŠçº¿ç¨‹å†åˆ‡å›æ¥ã€‚

> è¿™ä¸ªã€Œåˆ‡å›æ¥ã€æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

æˆ‘ä»¬çš„åç¨‹åŸæœ¬æ˜¯è¿è¡Œåœ¨ä¸»çº¿ç¨‹çš„ï¼Œå½“ä»£ç é‡åˆ° suspend å‡½æ•°çš„æ—¶å€™ï¼Œå‘ç”Ÿçº¿ç¨‹åˆ‡æ¢ï¼Œæ ¹æ® Dispatchers åˆ‡æ¢åˆ°äº† IO çº¿ç¨‹ï¼›

å½“è¿™ä¸ªå‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œçº¿ç¨‹åˆåˆ‡äº†å›æ¥ï¼Œã€Œåˆ‡å›æ¥ã€ä¹Ÿå°±æ˜¯åç¨‹ä¼šå¸®æˆ‘å† post ä¸€ä¸ª Runnableï¼Œè®©æˆ‘å‰©ä¸‹çš„ä»£ç ç»§ç»­å›åˆ°ä¸»çº¿ç¨‹å»æ‰§è¡Œã€‚

> ã€Œéé˜»å¡å¼ã€æŒ‚èµ·æŒ‡çš„æ˜¯ç”¨çœ‹èµ·æ¥é˜»å¡çš„ä»£ç å†™å‡ºéé˜»å¡å¼æ“ä½œçš„ã€‚

## åç¨‹ç»ƒä¹ 
ä½¿ç”¨åç¨‹ä¸‹è½½ä¸€å¼ å›¾ï¼Œå¹¶è¡Œè¿›è¡Œä¸¤æ¬¡åˆ‡å‰²

- ä¸€æ¬¡åˆ‡æˆå¤§å°ç›¸åŒçš„ 4 ä»½ï¼Œå–å…¶ä¸­çš„ç¬¬ä¸€ä»½
- ä¸€æ¬¡åˆ‡æˆå¤§å°ç›¸åŒçš„ 9 ä»½ï¼Œå–å…¶ä¸­çš„æœ€åä¸€ä»½

å¾—åˆ°ç»“æœåï¼Œå°†å®ƒä»¬å±•ç¤ºåœ¨ä¸¤ä¸ª ImageView ä¸Šã€‚
```
GlobalScope.launch(Dispatchers.Main) {
    Log.w("coroutines","launch ${Thread.currentThread().name}")
    val bitmap = getSuspendImage()
    Log.w("coroutines","launch getImage Ok")
    iv1.setImageBitmap(bitmap)
    val bitmapHalf2 = Bitmap.createBitmap(bitmap, 0, 0, bitmap.width / 2, bitmap.height / 2)
    iv2.setImageBitmap(bitmapHalf2)
    val bitmapHalf3 = Bitmap.createBitmap(bitmap, 0, 0, bitmap.width / 3, bitmap.height / 3)
    iv3.setImageBitmap(bitmapHalf3)
}

private suspend fun getSuspendImage(): Bitmap = withContext(Dispatchers.IO) {
    Log.w("coroutines","suspend ${Thread.currentThread().name}")
    OkHttpClient()
            .newCall(Request.Builder()
                    .url("http://oss.tuyuing.com/TUYU/trend/20190930/trend257401569854904487.jpeg")
                    .get()
                    .build())
            .execute().body?.byteStream().use {
                Log.w("coroutines","suspend getImage Ok")
                BitmapFactory.decodeStream(it)
            }
}

Log :
W/coroutines: launch main
W/coroutines: suspend DefaultDispatcher-worker-1
W/coroutines: suspend getImage Ok
W/coroutines: launch getImage Ok
```
æ•ˆæœå›¾ :

<img alt="2020-04-22-Kotlinæ‰‹å†Œ-2e6fe29e.png" src="images/2020-04-22-Kotlinæ‰‹å†Œ-2e6fe29e.png" width="50%" height="100%" >









.
